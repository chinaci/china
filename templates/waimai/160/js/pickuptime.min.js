var pickuptime = {
  init: function (a, top, left, tflag, b) {
    this.setuptime = a;
    this.settop = top;
    this.setleft = left;
    if (tflag == 1) {
      this.run(b)
    } else {
      $("#pickuptimeContener").remove();
    }
  },
  marketgetTime: function () {
    var k = this.setuptime;
    var g = new Date();
    g.setDate(g.getDate() + k);
    var h = g.getDay();
    var l = g.getHours();
    var f = parseInt(h);
    var d = "";
    var a = ["周日", "周一", "周二", "周三", "周四", "周五", "周六"];
    var e = new Array();
    var b, j;
    for (var c = k; c < 3 + k; c++) {
      if (f == 7) {
        f = 0
      }
      if (c == 0) {
        b = g.getMonth() + 1;
        j = g.getDate();
        e.push(b + "月" + j + "日 " + a[f] + " (今天)")
      } else {
        if (c == 1) {
          g.setDate(g.getDate() + 1);
          b = g.getMonth() + 1;
          j = g.getDate();
          e.push(b + "月" + j + "日 " + a[f] + " (明天)")
        } else {
          if (c == 2) {
            g.setDate(g.getDate() + 1);
            b = g.getMonth() + 1;
            j = g.getDate();
            e.push(b + "月" + j + "日 " + a[f] + " (后天)")
          } else {
            g.setDate(g.getDate() + 1);
            b = g.getMonth() + 1;
            j = g.getDate();
            e.push(b + "月" + j + "日 " + a[f])
          }
        }
      }
      f++;
      j++
    }
    e.push(l);
    return e
  },
  todoble: function (a) {
    if (a < 10) {
      a = "0" + a + ":00"
    } else {
      a = a + ":00"
    }
    return a
  },
  jsdate: function (ntime) {//计算年月日
    var dd = new Date();
        dd.setDate(dd.getDate() + ntime);//获取ntime天后的日期
        var y = dd.getFullYear();
        var m = dd.getMonth() + 1;//获取当前月份的日期
        var d = dd.getDate();
    var w = dd.getDay();

    var dateData = y+'-'+m+'-'+d;
    return dateData;
  },
  run: function (f) {
    var c = this.marketgetTime();
    var a = "";
    var h = c[3];//当前小时
    var nowDate = new Date();
    var nowmin = nowDate.getMinutes();
    for (var b = 0; b < 24; b++) {
      for(var m=0; m<(60/20); m++){//20分钟一间隔
        var min = m?((m*20==60?(m*20-1):m*20)):"00";
        if(b<h  ||(b==h && nowmin>(min*1))){
          a += "<li class='pickuptime pickuptime-sp hide'>" +b+':'+min+ "</li>"
        }else {         
          a += "<li class='pickuptime'>" + b+':'+min + "</li>"
          
        }    
      }
      // if (b <= c[3]) {
      //   a += "<li class='pickuptime pickuptime-sp hide'>" + this.todoble(b) + "</li>"
      // }else {
      //   if (b == Number(c[3]) + 1) {
      //     a += "<li class='pickuptime pickuptime-on'>" + this.todoble(b) + "</li>"
      //   } else {
      //     a += "<li class='pickuptime'>" + this.todoble(b) + "</li>"
      //   }
      // }
    }
    var dayD,datArr= [];
    for(var nt = 0; nt<3; nt++){//取左侧三天的年月日
       dayD = this.jsdate(+nt);
       datArr.push(dayD);
    }
    
    var e = "<div id='pickuptimeContener' style='top:" + this.settop + "px;left:" + this.setleft + "px;bottom:auto;width:325px;height:165px;background:transparent'><div class='pickuptime-close-empty' style='display:none;'></div><div id='pickuptime' style='position:absolute;bottom:0;'><p class='pickuptime-title' style='display:none;'>请选择取货时间</p><div class='pickuptime-box'><div class='pickuptime-data'><p class='pickuptime-datap pickuptime-data-on' data-ymd="+datArr[0]+">" + c[0] + "</p><p class='pickuptime-datap' data-ymd="+datArr[1]+">" + c[1] + "</p><p class='pickuptime-datap' data-ymd="+datArr[2]+">" + c[2] + "</p></div>";
    e += "<ul>" + a + "</ul></div><div class='pickuptime-close' style='display:none;'>关闭</div></div>";
    if ($("#pickuptimeContener").length > 0) {
      $("#pickuptimeContener").remove()
    }
    $("body").append(e);
    var d = $(window).height() - $(".pickuptime-title").offset().top;
    $(".pickuptime-close-empty").css("height", d + "px");
    $(".pickuptime-close-empty,.pickuptime-close").on("click", function () {
      $("#pickuptimeContener").remove()
    });
    $(".pickuptime-datap").on("click", function () {
      var g = $(this).index();
      if (g != 0) {
        $(".pickuptime-sp").show()
      } else {
        $(".pickuptime-sp").hide()
      }
      $(this).addClass("pickuptime-data-on").siblings().removeClass("pickuptime-data-on")
    });
    $(".pickuptime").on("click", function () {
      $(this).addClass("pickuptime-on").siblings().removeClass("pickuptime-on");
      var gArr=[]
      var g = $(".pickuptime-data-on").text() + " " + $(".pickuptime-on").text();
      var g2 =$(".pickuptime-data-on").attr('data-ymd')+' '+$(".pickuptime-on").text();
      gArr=[g,g2]
      $(".pickuptime-close-empty").click();
      if (Object.prototype.toString.call(f) === "[object Function]") {
        f(gArr)
      } else {
        return false
      }
    })
  }
};